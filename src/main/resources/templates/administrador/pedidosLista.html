<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Pedidos - UTPedidos</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <!-- Admin Theme CSS -->
    <link rel="stylesheet" th:href="@{/css/admin-theme.css}" />
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}" />
  </head>
  <body>
    <div class="admin-layout">
      <!-- Sidebar -->
      <!-- Navbar -->
      <div th:replace="~{fragments/navbarAdmin :: navbarA('pedidos')}"></div>

      <!-- Contenido principal -->
      <main class="container-fluid main-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="mb-1">
              <i class="bi bi-receipt text-primary"></i>
              Gestión de Pedidos
            </h2>
            <p class="text-muted mb-0">
              <span th:text="${totalPedidos != null ? totalPedidos : 0}"
                >0</span
              >
              pedidos totales
            </p>
          </div>
          <div class="d-flex gap-2">
            <!-- Botón para actualizar -->
            <a th:href="@{/admin/pedidos}" class="btn btn-outline-primary">
              <i class="bi bi-arrow-clockwise"></i> Actualizar
            </a>
            <!-- Búsqueda por código -->
            <form
              th:action="@{/admin/pedidos/buscar}"
              method="post"
              class="d-flex gap-2 flex-fill"
            >
              <input
                type="text"
                name="codigo"
                class="form-control"
                placeholder="Buscar por código..."
                required
                pattern="[A-Z]{3}[0-9]{3}"
                title="Formato: ABC123"
              />
              <button
                type="submit"
                class="btn btn-primary"
                style="min-width: 110px"
              >
                <i class="bi bi-search"></i> Buscar
              </button>
            </form>
          </div>
        </div>

        <!-- Mensaje con SweetAlert2 se muestra via script al final -->

        <!-- Tabs de Estados -->
        <ul class="nav nav-tabs mb-4" id="pedidosTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="pendientes-tab"
              data-bs-toggle="tab"
              data-bs-target="#pendientes"
              type="button"
            >
              <i class="bi bi-clock-history text-warning"></i>
              Pendientes
              <span
                class="badge bg-warning text-dark ms-2"
                th:text="${pedidosPendientes != null ? pedidosPendientes.size() : 0}"
                >0</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="enPreparacion-tab"
              data-bs-toggle="tab"
              data-bs-target="#enPreparacion"
              type="button"
            >
              <i class="bi bi-hourglass-split text-info"></i>
              En Preparación
              <span
                class="badge bg-info ms-2"
                th:text="${pedidosEnPreparacion != null ? pedidosEnPreparacion.size() : 0}"
                >0</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="listos-tab"
              data-bs-toggle="tab"
              data-bs-target="#listos"
              type="button"
            >
              <i class="bi bi-check-circle text-success"></i>
              Listos
              <span
                class="badge bg-success ms-2"
                th:text="${pedidosListos != null ? pedidosListos.size() : 0}"
                >0</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="entregados-tab"
              data-bs-toggle="tab"
              data-bs-target="#entregados"
              type="button"
            >
              <i class="bi bi-bag-check text-secondary"></i>
              Entregados
              <span
                class="badge bg-secondary ms-2"
                th:text="${pedidosEntregados != null ? pedidosEntregados.size() : 0}"
                >0</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="cancelados-tab"
              data-bs-toggle="tab"
              data-bs-target="#cancelados"
              type="button"
            >
              <i class="bi bi-x-circle text-danger"></i>
              Cancelados
              <span
                class="badge bg-danger ms-2"
                th:text="${pedidosCancelados != null ? pedidosCancelados.size() : 0}"
                >0</span
              >
            </button>
          </li>
        </ul>

        <!-- Contenido de Tabs -->
        <div class="tab-content" id="pedidosTabContent">
          <!-- Tab Pendientes -->
          <div
            class="tab-pane fade show active"
            id="pendientes"
            role="tabpanel"
          >
            <div
              th:replace="~{fragments/pedidosTabla :: tablaFragment(pedidos=${pedidosPendientes}, mostrarAccion=true, accionTexto='Iniciar Preparación')}"
            ></div>
          </div>

          <!-- Tab En Preparación -->
          <div class="tab-pane fade" id="enPreparacion" role="tabpanel">
            <div
              th:replace="~{fragments/pedidosTabla :: tablaFragment(pedidos=${pedidosEnPreparacion}, mostrarAccion=true, accionTexto='Marcar Listo')}"
            ></div>
          </div>

          <!-- Tab Listos -->
          <div class="tab-pane fade" id="listos" role="tabpanel">
            <div
              th:replace="~{fragments/pedidosTabla :: tablaFragment(pedidos=${pedidosListos}, mostrarAccion=true, accionTexto='Marcar Entregado')}"
            ></div>
          </div>

          <!-- Tab Entregados -->
          <div class="tab-pane fade" id="entregados" role="tabpanel">
            <div
              th:replace="~{fragments/pedidosTabla :: tablaFragment(pedidos=${pedidosEntregados}, mostrarAccion=false, accionTexto='')}"
            ></div>
          </div>

          <!-- Tab Cancelados -->
          <div class="tab-pane fade" id="cancelados" role="tabpanel">
            <div
              th:replace="~{fragments/pedidosTabla :: tablaFragment(pedidos=${pedidosCancelados}, mostrarAccion=false, accionTexto='')}"
            ></div>
          </div>
        </div>
      </main>
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/sweetalert-utils.js}"></script>

    <script th:inline="javascript">
      // Mostrar mensaje con SweetAlert2 si existe
      /*<![CDATA[*/
      const mensaje = /*[[${mensaje}]]*/ null;
      const tipoMensaje = /*[[${tipoMensaje}]]*/ "info";
      const activeTab = /*[[${activeTab}]]*/ null;

      if (mensaje) {
        const icon =
          tipoMensaje === "success"
            ? "success"
            : tipoMensaje === "danger"
            ? "error"
            : tipoMensaje === "warning"
            ? "warning"
            : "info";
        Swal.fire({
          icon: icon,
          title:
            tipoMensaje === "success"
              ? "Éxito"
              : tipoMensaje === "danger"
              ? "Error"
              : "Información",
          text: mensaje,
          confirmButtonColor: "#0d6efd",
          timer: tipoMensaje === "success" ? 3000 : undefined,
          timerProgressBar: tipoMensaje === "success",
        });
      }
      /*]]>*/

      // Restaurar el tab activo si existe
      document.addEventListener("DOMContentLoaded", function () {
        if (activeTab) {
          const tabButton = document.getElementById(activeTab + "-tab");
          if (tabButton) {
            const tab = new bootstrap.Tab(tabButton);
            tab.show();
          }
        }

        // Capturar el tab actual en todos los formularios
        document
          .querySelectorAll(".nav-tabs .nav-link")
          .forEach(function (tabLink) {
            tabLink.addEventListener("shown.bs.tab", function (e) {
              const currentTabId = e.target.id.replace("-tab", "");
              // Actualizar todos los inputs hidden con el tab actual
              document
                .querySelectorAll(".current-tab-input")
                .forEach(function (input) {
                  input.value = currentTabId;
                });
            });
          });

        // Inicializar el valor del tab actual al cargar
        const activeTabButton = document.querySelector(
          ".nav-tabs .nav-link.active"
        );
        if (activeTabButton) {
          const currentTabId = activeTabButton.id.replace("-tab", "");
          document
            .querySelectorAll(".current-tab-input")
            .forEach(function (input) {
              input.value = currentTabId;
            });
        }
      });

      // Auto-actualizar cada 30 segundos
      setInterval(function () {
        location.reload();
      }, 30000);
    </script>
  </body>
</html>
