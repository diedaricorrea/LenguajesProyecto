<!DOCTYPE html>
<html lang="es" xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>navbar</title>
</head>

<body>
<header th:fragment="navbarU">
    <nav class="navbar navbar-expand-lg custom-navbar sticky-top shadow-sm">
        <div class="container-fluid px-4">
            <!-- LOGO -->
            <a class="navbar-brand d-flex align-items-center me-4" th:href="@{/catalogo}">
                <i class="bi bi-cup-hot-fill me-2 fs-4 text-warning"></i>
                <span class="logo-coffee">Coffee</span>
                <span class="logo-utpedidos">UTPedidos</span>
            </a>
            
            <!-- Botón responsive -->
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Contenido navbar -->
            <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
                <!-- Enlaces a la izquierda -->
                <ul class="navbar-nav gap-3 mx-auto mx-lg-0">
                    <li class="nav-item">
                        <a class="nav-link nav-link-custom d-flex align-items-center" th:href="@{/catalogo}">
                            <i class="bi bi-grid-fill me-2"></i>
                            <span>Menú</span>
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="isAuthenticated()">
                        <a class="nav-link nav-link-custom d-flex align-items-center" th:href="@{/carrito}">
                            <i class="bi bi-cart-fill me-2"></i>
                            <span>Carrito</span>
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="isAuthenticated()">
                        <a class="nav-link nav-link-custom d-flex align-items-center" th:href="@{/pedidos}">
                            <i class="bi bi-receipt-cutoff me-2"></i>
                            <span>Pedidos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-custom d-flex align-items-center" th:href="@{/sobre-nosotros}">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <span>Nosotros</span>
                        </a>
                    </li>
                </ul>
                
                <!-- Sección derecha -->
                <div class="d-flex align-items-center gap-3 mt-3 mt-lg-0">
                    <!-- Notificaciones (solo autenticados) -->
                    <div class="notification-bell position-relative" sec:authorize="isAuthenticated()" onclick="toggleNotifications()" style="cursor: pointer;">
                        <i class="bi bi-bell-fill fs-5"></i>
                        <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                              th:if="${notificaciones != null && !notificaciones.isEmpty()}"
                              th:text="${notificaciones.size()}">0</span>
                    </div>
                    
                    <!-- Usuario autenticado -->
                    <div class="dropdown" sec:authorize="isAuthenticated()">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle"
                           id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                 style="width: 40px; height: 40px;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <span class="d-none d-md-inline text-dark fw-semibold" th:text="${usuarioNombre}">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                            <li class="px-3 py-2">
                                <h6 class="mb-0 text-muted">Hola, <span class="text-dark" th:text="${usuarioNombre}"></span></h6>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li sec:authorize="hasAnyAuthority('ROLE_ADMINISTRADOR', 'ROLE_TRABAJADOR')">
                                <a class="dropdown-item" th:href="@{/admin/productos}">
                                    <i class="bi bi-speedometer2 me-2"></i>Panel Admin
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" th:href="@{/logout}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Botones para usuarios NO autenticados -->
                    <div class="d-flex gap-2" sec:authorize="!isAuthenticated()">
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="bi bi-box-arrow-in-right me-1"></i>
                            Iniciar Sesión
                        </button>
                        <button class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#registerModal">
                            <i class="bi bi-person-plus me-1"></i>
                            Registrarse
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Modal lateral de notificaciones (solo autenticados) -->
    <div id="notification-modal" class="notification-modal hidden" sec:authorize="isAuthenticated()" onclick="closeNotifications(event)">
        <div class="notification-content" onclick="event.stopPropagation()">
            <div class="notification-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Notificaciones</h5>
                <div class="d-flex gap-2 align-items-center">
                    <button th:if="${notificaciones != null && !notificaciones.isEmpty()}" 
                            type="button"
                            id="btnLimpiarTodas"
                            class="btn btn-sm btn-outline-danger" 
                            title="Limpiar todas"
                            onclick="confirmarLimpiarNotificaciones();">
                        <i class="bi bi-trash"></i>
                    </button>
                    <span onclick="closeNotifications(event)" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
                </div>
            </div>
            
            <div th:if="${notificaciones == null || notificaciones.isEmpty()}" 
                 class="notification-body text-center p-4">
                <i class="bi bi-bell-slash fs-1 text-muted"></i>
                <p class="text-muted mt-2">No tienes notificaciones</p>
            </div>
            
            <div th:if="${notificaciones != null && !notificaciones.isEmpty()}" class="notification-body">
                <div th:each="notificacion, iterStat : ${notificaciones}" 
                     th:if="${iterStat.index < 10}"
                     class="d-flex align-items-start p-3 mb-2 rounded shadow-sm position-relative"
                     th:classappend="${notificacion.estado} ? 'bg-light' : 'bg-warning-subtle border-start border-5 border-warning'">
                    <i class="bi bi-bell-fill me-3 fs-4 text-warning"></i>
                    <div class="flex-grow-1">
                        <p class="mb-1 fw-semibold" th:text="${notificacion.mensaje}">Mensaje</p>
                    </div>
                    <button type="button" 
                            class="btn btn-sm btn-link text-danger p-0 ms-2 btn-eliminar-notif" 
                            th:data-id="${notificacion.idNotificacion}"
                            title="Eliminar">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                
                <div th:if="${notificaciones.size() > 10}" 
                     class="text-center p-2 text-muted small">
                    <i class="bi bi-info-circle"></i>
                    Mostrando las últimas 10 de <span th:text="${notificaciones.size()}">0</span> notificaciones
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-eliminar-notif').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const idNotificacion = this.getAttribute('data-id');
                    const notifElement = this.closest('.d-flex');
                    
                    const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
                    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
                    
                    fetch('/notificacion/eliminar', {
                        method: 'POST',
                        headers: headers,
                        body: 'idNotificacion=' + idNotificacion
                    })
                    .then(response => {
                        if (response.ok) {
                            notifElement.style.transition = 'opacity 0.3s';
                            notifElement.style.opacity = '0';
                            setTimeout(() => {
                                notifElement.remove();
                                const badge = document.querySelector('.notification-badge');
                                if (badge) {
                                    const count = parseInt(badge.textContent) - 1;
                                    if (count > 0) {
                                        badge.textContent = count;
                                    } else {
                                        badge.remove();
                                        const notifBody = document.querySelector('.notification-body');
                                        if (notifBody && notifBody.children.length === 0) {
                                            location.reload();
                                        }
                                    }
                                }
                            }, 300);
                        }
                    });
                });
            });
        });
        
        function confirmarLimpiarNotificaciones() {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: '¿Eliminar todas las notificaciones?',
                    text: 'Esta acción no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, eliminar todas',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
                        if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
                        
                        fetch('/notificacion/eliminar-todas', {
                            method: 'POST',
                            headers: headers
                        })
                        .then(response => {
                            if (response.ok) location.reload();
                            else Swal.fire('Error', 'No se pudieron eliminar las notificaciones', 'error');
                        });
                    }
                });
            }
        }
    </script>
</header>
</body>
</html>