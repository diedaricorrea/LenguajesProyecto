<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - UTPedidos</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <style>
        .timeline {
            position: relative;
            padding-left: 3rem;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 0.9rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-step {
            position: relative;
            padding-bottom: 2rem;
        }
        .timeline-step::before {
            content: '';
            position: absolute;
            left: -2.25rem;
            top: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: white;
            border: 3px solid #dee2e6;
            z-index: 1;
        }
        .timeline-step.active::before {
            border-color: #0d6efd;
            background: #0d6efd;
        }
        .timeline-step.completed::before {
            border-color: #198754;
            background: #198754;
        }
        .pedido-listo-alert {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(25, 135, 84, 0); }
        }
    </style>
</head>

<body>
    <!-- navbar -->
    <div th:replace="~{fragments/navbarUsuario :: navbarU}"></div>

    <!-- Contenido principal -->
    <main class="py-4">
        <div class="container">
            <h1 class="display-5 fw-bold mb-4">
                <i class="bi bi-receipt"></i> Mis Pedidos
            </h1>

            <!-- Las notificaciones se muestran solo en el modal lateral -->

            <!-- Pedidos Activos -->
            <div class="mb-5">
                <h3 class="mb-3">
                    <i class="bi bi-clock-history text-primary"></i> Pedidos Activos
                </h3>
                
                <div th:if="${pedidosActivos == null || pedidosActivos.isEmpty()}" 
                     class="alert alert-info text-center">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    <p class="mb-0">No tienes pedidos activos en este momento</p>
                    <a th:href="@{/catalogo}" class="btn btn-primary mt-3">
                        <i class="bi bi-cart-plus"></i> Ir al Catálogo
                    </a>
                </div>

                <div class="row g-4">
                    <div th:each="pedido : ${pedidosActivos}" class="col-12 col-lg-6">
                        <div class="card shadow-lg h-100" 
                             th:classappend="${pedido.estado.name() == 'LISTO'} ? 'border-success border-3 pedido-listo-alert' : ''">
                            
                            <!-- Header con estado -->
                            <div class="card-header" 
                                 th:classappend="'bg-' + ${pedido.estadoBootstrapClass} + ' bg-opacity-10'">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0 fw-bold" th:text="${pedido.codigoPedido}">ABC123</h4>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar3"></i>
                                            <span th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}"></span>
                                        </small>
                                    </div>
                                    <span class="badge fs-6" 
                                          th:classappend="'bg-' + ${pedido.estadoBootstrapClass}">
                                        <i th:classappend="${pedido.estadoIconClass}"></i>
                                        <span th:text="${pedido.estadoDisplayName}">Estado</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Body con tracking -->
                            <div class="card-body">
                                <!-- Alerta si está listo -->
                                <div th:if="${pedido.estado.name() == 'LISTO'}" 
                                     class="alert alert-success text-center mb-4">
                                    <i class="bi bi-check-circle-fill fs-1 d-block mb-2"></i>
                                    <h5 class="mb-0">¡Tu pedido está listo!</h5>
                                    <p class="mb-0">Puedes pasar a recogerlo</p>
                                </div>

                                <!-- Timeline de estados -->
                                <div class="timeline">
                                    <div class="timeline-step" 
                                         th:classappend="${pedido.estado.ordinal() >= 0} ? 'completed' : ''">
                                        <strong>Pedido Recibido</strong>
                                        <small class="d-block text-muted">Tu pedido ha sido confirmado</small>
                                    </div>
                                    <div class="timeline-step" 
                                         th:classappend="${pedido.estado.ordinal() >= 1} ? (${pedido.estado.ordinal() == 1} ? 'active' : 'completed') : ''">
                                        <strong>En Preparación</strong>
                                        <small class="d-block text-muted">Estamos preparando tu pedido</small>
                                    </div>
                                    <div class="timeline-step" 
                                         th:classappend="${pedido.estado.ordinal() >= 2} ? (${pedido.estado.ordinal() == 2} ? 'active' : 'completed') : ''">
                                        <strong>Listo para Recoger</strong>
                                        <small class="d-block text-muted">Tu pedido está listo</small>
                                    </div>
                                </div>

                                <!-- Hora de entrega -->
                                <div class="alert alert-light mb-3">
                                    <i class="bi bi-clock text-primary"></i>
                                    <strong>Hora de entrega programada:</strong>
                                    <span class="fs-5 fw-bold ms-2" 
                                          th:text="${#temporals.format(pedido.fechaEntrega, 'HH:mm')}">12:00</span>
                                </div>

                                <!-- Productos -->
                                <h6 class="border-bottom pb-2">
                                    <i class="bi bi-cart3"></i> Productos
                                </h6>
                                <div class="list-group list-group-flush mb-3">
                                    <div th:each="detalle : ${pedido.detalles}" 
                                         class="list-group-item px-0 py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-primary rounded-pill" 
                                                      th:text="${detalle.cantidad}">1</span>
                                                <span th:text="${detalle.nombreProducto}">Producto</span>
                                            </div>
                                            <span class="text-muted">
                                                S/ <span th:text="${#numbers.formatDecimal(detalle.subtotal, 1, 2)}">0.00</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Total -->
                                <div class="border-top pt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Total:</h5>
                                        <h4 class="mb-0 text-primary">
                                            S/ <span th:text="${#numbers.formatDecimal(pedido.total, 1, 2)}">0.00</span>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Pedidos -->
            <div>
                <h3 class="mb-3">
                    <i class="bi bi-archive text-secondary"></i> Historial de Pedidos
                </h3>
                
                <div th:if="${pedidosCompletados == null || pedidosCompletados.isEmpty()}" 
                     class="alert alert-secondary">
                    <i class="bi bi-inbox"></i> No tienes pedidos completados
                </div>

                <div th:unless="${pedidosCompletados == null || pedidosCompletados.isEmpty()}" 
                     class="accordion" id="historialAccordion">
                    <div th:each="pedido, iterStat : ${pedidosCompletados}" class="accordion-item">
                        <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    th:attr="data-bs-target='#collapse' + ${iterStat.index}">
                                <div class="w-100 d-flex justify-content-between align-items-center me-3">
                                    <div>
                                        <strong th:text="${pedido.codigoPedido}">ABC123</strong>
                                        <span class="text-muted ms-2">
                                            <i class="bi bi-calendar3"></i>
                                            <span th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy')}"></span>
                                        </span>
                                    </div>
                                    <span class="badge" 
                                          th:classappend="'bg-' + ${pedido.estadoBootstrapClass}"
                                          th:text="${pedido.estadoDisplayName}">Estado</span>
                                </div>
                            </button>
                        </h2>
                        <div th:id="'collapse' + ${iterStat.index}" 
                             class="accordion-collapse collapse" 
                             th:attr="data-bs-parent='#historialAccordion'">
                            <div class="accordion-body">
                                <div class="list-group list-group-flush">
                                    <div th:each="detalle : ${pedido.detalles}" 
                                         class="list-group-item">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <span class="badge bg-secondary me-2" 
                                                      th:text="${detalle.cantidad}">1</span>
                                                <span th:text="${detalle.nombreProducto}">Producto</span>
                                            </div>
                                            <span>S/ <span th:text="${#numbers.formatDecimal(detalle.subtotal, 1, 2)}">0.00</span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 text-end">
                                    <strong>Total: S/ <span th:text="${#numbers.formatDecimal(pedido.total, 1, 2)}">0.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script th:src="@{/js/notificacion.js}"></script>
    
    <!-- Auto-refresh cada 30 segundos para pedidos activos -->
    <script>
        // Refresh automático solo si hay pedidos activos no finales
        const hayPedidosActivos = /*[[${pedidosActivos}]]*/ null;
        if (hayPedidosActivos && hayPedidosActivos.length > 0) {
            setTimeout(() => location.reload(), 30000);
        }
    </script>
</body>

</html>
